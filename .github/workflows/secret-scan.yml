name: Secret Scan
true:
  pull_request: null
  push:
    branches:
    - main
    - master
  schedule:
  - cron: 17 5 * * *
  workflow_dispatch: null
permissions:
  contents: read
  security-events: write
  actions: read
jobs:
  gitleaks:
    name: gitleaks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - name: Checkout (full history)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Install gitleaks
      shell: bash
      env:
        GITLEAKS_VERSION: 8.24.2
      run: "set -euo pipefail\ncurl -sSfL \"https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz\"\
        \ \\\n  | tar -xz gitleaks\ninstall -m 0755 gitleaks \"${RUNNER_TEMP}/gitleaks\"\
        \necho \"${RUNNER_TEMP}\" >> \"${GITHUB_PATH}\"\n"
    - name: Validate waiver metadata and expiration
      shell: bash
      run: bash scripts/validate-gitleaks-waivers.sh
    - name: Run gitleaks
      shell: bash
      run: "set -euo pipefail\ngitleaks git \\\n  --no-banner \\\n  --redact \\\n\
        \  --config .gitleaks.toml \\\n  --log-opts=\"--all\" \\\n  --report-format\
        \ sarif \\\n  --report-path gitleaks.sarif\n"
    - name: Upload SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gitleaks.sarif
